<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de PDFs d'Examen</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #052E2B, #0F766E, #A7F3D0);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-section {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="file"]:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2A0A12, #9F1239, #FDA4AF);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .info-box {
            background: #e8f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #555;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 5px;
        }

        .info-box p:last-child {
            margin-bottom: 0;
        }

        .success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        select, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: #f8f9ff;
            font-size: 14px;
            color: #333;
            transition: all 0.3s ease;
            appearance: auto;
        }

        select:hover, input[type="text"]:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.2);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÑ G√©n√©rateur d'examens avec nom, matricule et num√©ro de table</h1>
        <p class="subtitle">Possibilit√© de g√©n√©rer des listes de pr√©sence</p>

        <div class="info-box">
            <p><strong>Format CSV ou XLSX attendu :</strong></p>
            <p>‚Ä¢ Colonne 1 : Pr√©nom et nom</p>
            <p>‚Ä¢ Colonne 2 : Num√©ro d'identification (NI)</p>
            <p>‚Ä¢ Colonne 3 : Num√©ro de table</p>
            <p>‚Ä¢ Colonne 4 : Local</p>
            <p>‚Ä¢ Colonne 5 : Section</p>
        </div>

        <div class="upload-section">
            <label for="csvFile">üìä Fichier CSV ou XLSX des √©tudiants</label>
            <input type="file" id="csvFile" accept=".csv,.xlsx" required>
            <div id="detectionResult" style="margin-top:10px;font-size:13px;color:#333"></div>
        </div>

        <div class="upload-section" id="mappingUI" style="display:none;">
            <label>üîß V√©rifier / choisir les colonnes</label>
            <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center;">
                <input type="checkbox" id="nameSeparate"> <label for="nameSeparate" style="margin:0;font-weight:600;">Nom s√©par√© en Pr√©nom / Nom</label>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
                <div style="flex:1">
                    <label for="nameCombinedSelect">Pr√©nom et nom (combin√©)</label>
                    <select id="nameCombinedSelect"></select>
                </div>
                <div style="flex:1">
                    <label for="firstNameSelect">Pr√©nom (s√©par√©)</label>
                    <select id="firstNameSelect"></select>
                </div>
                <div style="flex:1">
                    <label for="lastNameSelect">Nom (s√©par√©)</label>
                    <select id="lastNameSelect"></select>
                </div>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
                <div style="flex:1">
                    <label for="niSelect">Num√©ro d'identification (NI)</label>
                    <select id="niSelect"></select>
                </div>
                <div style="flex:1">
                    <label for="tableSelect">Num√©ro de table</label>
                    <select id="tableSelect"></select>
                </div>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
                <div style="flex:1">
                    <label for="localSelect">Local</label>
                    <select id="localSelect"></select>
                </div>
                <div style="flex:1">
                    <label for="sectionSelect">Section</label>
                    <select id="sectionSelect"></select>
                </div>
            </div>
            <div style="font-size:12px;color:#666">Conseil : v√©rifiez et modifiez si n√©cessaire avant de g√©n√©rer.</div>
        </div>

        <div class="upload-section">
            <label for="pdfFile">üìë Mod√®le PDF de l'examen</label>
            <input type="file" id="pdfFile" accept=".pdf" required>
        </div>

        <div class="upload-section">
            <label for="listOption">üìã Liste de pr√©sence</label>
            <select id="listOption" onchange="toggleListFields()">
                <option value="none">Aucune liste</option>
                <option value="local">Liste des √©tudiants par locaux</option>
                <option value="section">Liste des √©tudiants par section</option>
            </select>
        </div>

        <div id="listFields" class="hidden">
            <div class="upload-section">
                <label for="evalName">üìù Nom de l'√©valuation</label>
                <input type="text" id="evalName" placeholder="Ex: Examen 1">
            </div>
            <div class="upload-section">
                <label for="courseName">üìö Num√©ro du cours</label>
                <input type="text" id="courseName" placeholder="Ex: STT-1500">
            </div>
        </div>

        <button id="generateBtn" onclick="generatePDFs()">
            üöÄ G√©n√©rer et T√©l√©charger le ZIP
        </button>

        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Initialisation...</div>
        </div>
    </div>

    <script>
        const { PDFDocument, rgb, StandardFonts } = PDFLib;

        // ========== CONFIGURATION DES POSITIONS ==========
        // Ajustez ces valeurs si les √©l√©ments ne sont pas parfaitement positionn√©s
        const CONFIG = {
            // Position du nom (en haut √† droite)
            nomX: 445,
            nomY: 88,  // Distance depuis le haut de la page
            nomSize: 12,
            
            // Position du NI (sous le nom)
            niX: 450,
            niY: 147,  // Distance depuis le haut de la page
            niSize: 16,
            
            // Position du num√©ro de table (coin bas droit)
            tableX: 88,  // Distance depuis le bord droit
            tableY: 38,  // Distance depuis le bas
            tableSize: 16
            ,
            // Position du local (coin bas gauche sur la page de couverture)
            localX: 40,
            localY: 38,
            localSize: 12
        };
        // ==================================================

        async function generatePDFs() {
            const csvFile = document.getElementById('csvFile').files[0];
            const pdfFile = document.getElementById('pdfFile').files[0];
            
            if (!csvFile || !pdfFile) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner les deux fichiers (CSV/XLSX et PDF)');
                return;
            }

            const listOption = document.getElementById('listOption').value;
            const evalName = document.getElementById('evalName').value.trim();
            const courseName = document.getElementById('courseName').value.trim();

            if (listOption !== 'none' && (!evalName || !courseName)) {
                alert('‚ö†Ô∏è Veuillez saisir le nom de l\'√©valuation et le num√©ro du cours pour g√©n√©rer les listes de pr√©sence.');
                return;
            }

            const progressDiv = document.getElementById('progress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const generateBtn = document.getElementById('generateBtn');

            try {
                // D√©sactiver le bouton et afficher la progression
                generateBtn.disabled = true;
                progressDiv.style.display = 'block';
                progressFill.style.width = '10%';
                progressText.textContent = 'Lecture des fichiers...';

                // Lire le CSV ou XLSX
                let csvText;
                if (csvFile.name.toLowerCase().endsWith('.xlsx')) {
                    const arrayBuffer = await csvFile.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    csvText = XLSX.utils.sheet_to_csv(firstSheet, { FS: ';' });
                } else {
                    csvText = await csvFile.text();
                }
                const students = parseCSV(csvText);
                
                if (students.length === 0) {
                    throw new Error('Aucun √©tudiant trouv√© dans le CSV. V√©rifiez le format du fichier.');
                }
                
                console.log(`${students.length} √©tudiants trouv√©s:`, students);
                
                progressFill.style.width = '20%';
                progressText.textContent = `${students.length} √©tudiants trouv√©s...`;

                // Lire le PDF template
                const pdfBytes = await pdfFile.arrayBuffer();
                
                progressFill.style.width = '30%';
                progressText.textContent = 'Chargement du mod√®le PDF...';

                // Cr√©er un ZIP
                const zip = new JSZip();

                // G√©n√©rer un PDF pour chaque √©tudiant
                for (let i = 0; i < students.length; i++) {
                    const student = students[i];
                    const progress = 30 + (i / students.length) * 60;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `G√©n√©ration du PDF pour ${student.name}... (${i + 1}/${students.length})`;

                    console.log(`Traitement de l'√©tudiant ${i + 1}:`, student);

                    // Charger une nouvelle copie du PDF pour chaque √©tudiant
                    const pdfDoc = await PDFDocument.load(pdfBytes);
                    const pages = pdfDoc.getPages();
                    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

                    console.log(`PDF charg√©, ${pages.length} pages trouv√©es`);

                    // Remplir les informations sur la premi√®re page
                    const firstPage = pages[0];
                    const { width, height } = firstPage.getSize();

                        // --- NOM (centr√© autour de CONFIG.nomX) ---
                        const nameText = student.name.toUpperCase();
                        const nameWidth = font.widthOfTextAtSize(nameText, CONFIG.nomSize);

                        firstPage.drawText(nameText, {
                        x: CONFIG.nomX - nameWidth / 2,
                        y: height - CONFIG.nomY,
                        size: CONFIG.nomSize,
                        font,
                        color: rgb(0, 0, 0),
                        });

                        // --- NI (centr√© autour de CONFIG.niX) ---
                        const niText = student.ni;
                        const niWidth = font.widthOfTextAtSize(niText, CONFIG.niSize);

                        firstPage.drawText(niText, {
                        x: CONFIG.niX - niWidth / 2,
                        y: height - CONFIG.niY,
                        size: CONFIG.niSize,
                        font,
                        color: rgb(0, 0, 0),
                        });
                        // --- LOCAL (bas gauche sur la page de couverture) ---
                        const localText = student.local || '';
                        if (localText) {
                            firstPage.drawText(localText, {
                                x: CONFIG.localX,
                                y: CONFIG.localY,
                                size: CONFIG.localSize,
                                font,
                                color: rgb(0, 0, 0),
                            });
                        }
                    // Num√©ro de table au bas de chaque page (coin inf√©rieur droit, DANS le rectangle)
                    for (let pageIndex = 0; pageIndex < pages.length; pageIndex++) {
                        const page = pages[pageIndex];
                        const { width: pageWidth } = page.getSize();
                        
                    for (let pageIndex = 0; pageIndex < pages.length; pageIndex++) {
                    const page = pages[pageIndex];
                    const { width: pageWidth } = page.getSize();

                    const tableText = student.table;
                    const tableWidth = font.widthOfTextAtSize(tableText, CONFIG.tableSize);

                    // Ton config actuel place le champ √† "pageWidth - tableX"
                    // On interpr√®te donc (pageWidth - tableX) comme le CENTRE du champ
                    const tableCenterX = pageWidth - CONFIG.tableX;

                    page.drawText(tableText, {
                        x: tableCenterX - tableWidth / 2,
                        y: CONFIG.tableY,
                        size: CONFIG.tableSize,
                        font,
                        color: rgb(0, 0, 0),
                    });
                    }
                    }

                    // Sauvegarder le PDF
                    const modifiedPdfBytes = await pdfDoc.save();
                    console.log(`PDF sauvegard√©, taille: ${modifiedPdfBytes.length} bytes`);
                    
                    // Ajouter au ZIP avec un nom de fichier nettoy√©
                    const fileName = sanitizeFileName(student.name);
                    const fullFileName = `${fileName}_${student.ni}.pdf`;
                    zip.file(fullFileName, modifiedPdfBytes);
                    console.log(`Ajout√© au ZIP: ${fullFileName}`);
                }

                // G√©n√©rer les listes de pr√©sence si demand√©
                if (listOption !== 'none') {
                    progressFill.style.width = '92%';
                    progressText.textContent = 'G√©n√©ration des listes de pr√©sence...';

                    const groupBy = listOption; // 'local' ou 'section'
                    const groups = {};
                    for (const student of students) {
                        const key = student[groupBy];
                        if (!groups[key]) groups[key] = [];
                        groups[key].push(student);
                    }

                    const groupKeys = Object.keys(groups).sort();
                    for (const groupValue of groupKeys) {
                        const attendancePdfBytes = await generateAttendancePDF(
                            groups[groupValue], groupBy, groupValue, evalName, courseName
                        );
                        const label = groupBy === 'local' ? 'Local' : 'Section';
                        const fileName = `listes_presence/Presence_${label}_${sanitizeFileName(groupValue)}.pdf`;
                        zip.file(fileName, attendancePdfBytes);
                    }
                }

                progressFill.style.width = '95%';
                progressText.textContent = 'Cr√©ation du fichier ZIP...';

                // G√©n√©rer le ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });

                progressFill.style.width = '100%';
                progressText.textContent = '‚úÖ T√©l√©chargement du ZIP...';

                // T√©l√©charger le ZIP
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = 'examens_personnalises.zip';
                link.click();

                // Message de succ√®s
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    progressFill.style.width = '0%';
                    alert(`‚úÖ Succ√®s ! ${students.length} PDFs ont √©t√© g√©n√©r√©s et t√©l√©charg√©s dans le ZIP.`);
                    generateBtn.disabled = false;
                }, 1000);

            } catch (error) {
                console.error('Erreur:', error);
                progressDiv.style.display = 'none';
                progressFill.style.width = '0%';
                generateBtn.disabled = false;
                alert('‚ùå Erreur lors de la g√©n√©ration des PDFs: ' + error.message);
            }
        }

        // ========== D√âTECTION AUTOMATIQUE DES COLONNES ==========
        function normalizeHeader(h) {
            if (!h) return '';
            return h.toString()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .toLowerCase()
                .replace(/[_\-\.,]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function isNameLike(header) {
            const h = normalizeHeader(header);
            const singleNameKeywords = ['prenom', 'pr√©nom', 'nom', 'nomprenom', 'prenomnom', 'prenom et nom', 'nom et pr√©nom', 'full name', 'fullname', 'name', 'nom complet', 'etudiant', 'student'];
            for (const k of singleNameKeywords) if (h.includes(k)) return true;
            if (/prenom.*nom|nom.*prenom|pr√©nom.*nom|nom.*pr√©nom|first\s*name.*last\s*name|last\s*name.*first\s*name/.test(h)) return true;
            const tokens = h.split(' ');
            if (tokens.length >= 2 && tokens.every(t => t.length > 1 && /^[a-z]+$/.test(t))) return true;
            return false;
        }

        function detectNameColumn(headers) {
            const normalized = headers.map(h => normalizeHeader(h));
            // 1) exact / contains
            for (let i = 0; i < normalized.length; i++) {
                if (isNameLike(normalized[i])) return { type: 'combined', indices: [i], score: 0.95, match: headers[i] };
            }
            // 2) adjacent pair detection (prenom / nom)
            const firstKeywords = ['prenom','pr√©nom','first','given'];
            const lastKeywords = ['nom','last','family','surname'];
            for (let i = 0; i < normalized.length - 1; i++) {
                const a = normalized[i], b = normalized[i+1];
                if ((firstKeywords.some(k=>a.includes(k)) && lastKeywords.some(k=>b.includes(k))) ||
                    (firstKeywords.some(k=>b.includes(k)) && lastKeywords.some(k=>a.includes(k)))) {
                    return { type: 'separate', indices: [i, i+1], score: 0.9, match: headers[i] + ' / ' + headers[i+1] };
                }
            }
            // 3) fallback heuristics
            const candidates = [];
            for (let i = 0; i < normalized.length; i++) {
                const h = normalized[i];
                if (h.split(' ').length >= 2 || /name|nom|prenom|pr√©nom/.test(h)) candidates.push({ i, h });
            }
            if (candidates.length === 1) return { type: 'combined', indices: [candidates[0].i], score: 0.6, match: headers[candidates[0].i] };
            return { type: 'none', indices: [], score: 0, match: null };
        }

        function detectSingleColumn(headers, keywords) {
            const normalized = headers.map(h => normalizeHeader(h));
            for (let i = 0; i < normalized.length; i++) {
                for (const k of keywords) {
                    if (normalized[i].includes(k)) return i;
                }
            }
            return -1;
        }

        // ====== UI: remplir les selects de mapping √† l'ouverture du fichier ======
        let columnHeaders = [];
        const columnMapping = {
            nameMode: 'combined', // or 'separate'
            nameIdx: null,
            firstIdx: null,
            lastIdx: null,
            niIdx: null,
            tableIdx: null,
            localIdx: null,
            sectionIdx: null
        };

        document.getElementById('csvFile').addEventListener('change', onCsvFileSelected);
        document.getElementById('nameSeparate').addEventListener('change', (e) => {
            const separate = e.target.checked;
            columnMapping.nameMode = separate ? 'separate' : 'combined';
            document.getElementById('nameCombinedSelect').disabled = separate;
            document.getElementById('firstNameSelect').disabled = !separate;
            document.getElementById('lastNameSelect').disabled = !separate;
        });

        ['nameCombinedSelect','firstNameSelect','lastNameSelect','niSelect','tableSelect','localSelect','sectionSelect']
            .forEach(id => document.getElementById(id).addEventListener('change', () => updateMappingFromUI()));

        async function onCsvFileSelected(e) {
            const file = e.target.files[0];
            if (!file) return;
            let headers = [];
            try {
                if (file.name.toLowerCase().endsWith('.xlsx')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    if (rows && rows.length) headers = (rows[0] || []).map(h => h === undefined ? '' : h.toString());
                } else {
                    const text = await file.text();
                    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
                    if (lines.length) {
                        const first = lines[0];
                        const sep = first.includes(';') ? ';' : (first.includes(',') ? ',' : ',');
                        headers = first.split(sep).map(h => h === undefined ? '' : h.toString().trim());
                    }
                }
            } catch (err) {
                console.error('Erreur lecture en-t√™tes:', err);
            }

            columnHeaders = headers;
            if (headers.length === 0) return;

            populateAllSelects(headers);
            document.getElementById('mappingUI').style.display = 'block';

            // Pr√©-s√©lectionner √† partir de la d√©tection heuristique
            const detection = detectNameColumn(headers);
            if (detection.type === 'separate') {
                document.getElementById('nameSeparate').checked = true;
                columnMapping.nameMode = 'separate';
                document.getElementById('firstNameSelect').value = String(detection.indices[0]);
                document.getElementById('lastNameSelect').value = String(detection.indices[1]);
            } else if (detection.type === 'combined') {
                document.getElementById('nameSeparate').checked = false;
                columnMapping.nameMode = 'combined';
                document.getElementById('nameCombinedSelect').value = String(detection.indices[0]);
            }

            // autres champs
            const ni = detectSingleColumn(headers, ['ni','matricule','identifiant','id','numero','num']);
            if (ni >= 0) document.getElementById('niSelect').value = String(ni);
            const table = detectSingleColumn(headers, ['table','no table','numero table','num table']);
            if (table >= 0) document.getElementById('tableSelect').value = String(table);
            const local = detectSingleColumn(headers, ['local','salle','room','location']);
            if (local >= 0) document.getElementById('localSelect').value = String(local);
            const section = detectSingleColumn(headers, ['section','groupe','group']);
            if (section >= 0) document.getElementById('sectionSelect').value = String(section);

            updateMappingFromUI();
        }

        function populateAllSelects(headers) {
            const ids = ['nameCombinedSelect','firstNameSelect','lastNameSelect','niSelect','tableSelect','localSelect','sectionSelect'];
            ids.forEach(id => populateSelect(id, headers));
            // enable/disable according to current mode
            const separate = document.getElementById('nameSeparate').checked;
            document.getElementById('nameCombinedSelect').disabled = separate;
            document.getElementById('firstNameSelect').disabled = !separate;
            document.getElementById('lastNameSelect').disabled = !separate;
        }

        function populateSelect(id, headers) {
            const sel = document.getElementById(id);
            sel.innerHTML = '';
            headers.forEach((h, idx) => {
                const o = document.createElement('option');
                o.value = String(idx);
                o.textContent = `${idx+1}: ${h}`;
                sel.appendChild(o);
            });
            const none = document.createElement('option');
            none.value = '';
            none.textContent = '-- non d√©fini --';
            sel.insertBefore(none, sel.firstChild);
        }

        function updateMappingFromUI() {
            const separate = document.getElementById('nameSeparate').checked;
            columnMapping.nameMode = separate ? 'separate' : 'combined';
            columnMapping.nameIdx = document.getElementById('nameCombinedSelect').value === '' ? null : parseInt(document.getElementById('nameCombinedSelect').value,10);
            columnMapping.firstIdx = document.getElementById('firstNameSelect').value === '' ? null : parseInt(document.getElementById('firstNameSelect').value,10);
            columnMapping.lastIdx = document.getElementById('lastNameSelect').value === '' ? null : parseInt(document.getElementById('lastNameSelect').value,10);
            columnMapping.niIdx = document.getElementById('niSelect').value === '' ? null : parseInt(document.getElementById('niSelect').value,10);
            columnMapping.tableIdx = document.getElementById('tableSelect').value === '' ? null : parseInt(document.getElementById('tableSelect').value,10);
            columnMapping.localIdx = document.getElementById('localSelect').value === '' ? null : parseInt(document.getElementById('localSelect').value,10);
            columnMapping.sectionIdx = document.getElementById('sectionSelect').value === '' ? null : parseInt(document.getElementById('sectionSelect').value,10);
        }

        function parseCSV(csvText) {
            csvText = csvText.replace(/^\uFEFF/, '');
            const lines = csvText.split(/\r?\n/).filter(l => l.trim() !== '');
            const students = [];
            if (lines.length === 0) return students;

            // D√©tecter s√©parateur √† partir de la premi√®re ligne
            const headerLine = lines[0];
            const sep = headerLine.includes(';') ? ';' : (headerLine.includes(',') ? ',' : ',');
            const headers = headerLine.split(sep).map(h => (h === undefined ? '' : h.trim()));

            const detection = detectNameColumn(headers);

            const niKeywords = ['ni','matricule','identifiant','id','numero','num','matricule'];
            const tableKeywords = ['table','no table','no_table','numero table','numero de table','num table','tableau'];
            const localKeywords = ['local','salle','room','location'];
            const sectionKeywords = ['section','groupe','group','groupes'];

            const niIndex = detectSingleColumn(headers, niKeywords);
            const tableIndex = detectSingleColumn(headers, tableKeywords);
            const localIndex = detectSingleColumn(headers, localKeywords);
            const sectionIndex = detectSingleColumn(headers, sectionKeywords);

            // Afficher le r√©sultat de la d√©tection pour l'utilisateur
            const mappingLines = [];
            if (detection.type !== 'none') {
                mappingLines.push(`<strong>D√©tection nom:</strong> ${detection.match} (type: ${detection.type}, score: ${Math.round(detection.score*100)}%)`);
            } else {
                mappingLines.push('<strong>D√©tection nom:</strong> non trouv√©e ‚Äî utilisation des positions par d√©faut (1..5)');
            }
            mappingLines.push(`<strong>NI:</strong> ${niIndex>=0 ? headers[niIndex] : 'non d√©tect√©'}`);
            mappingLines.push(`<strong>Table:</strong> ${tableIndex>=0 ? headers[tableIndex] : 'non d√©tect√©'}`);
            mappingLines.push(`<strong>Local:</strong> ${localIndex>=0 ? headers[localIndex] : 'non d√©tect√©'}`);
            mappingLines.push(`<strong>Section:</strong> ${sectionIndex>=0 ? headers[sectionIndex] : 'non d√©tect√©'}`);
            const detDiv = document.getElementById('detectionResult');
            if (detDiv) detDiv.innerHTML = mappingLines.join('<br>');

            // Fallback indices par d√©faut
            const fallback = { nameIdx: 0, niIdx: 1, tableIdx: 2, localIdx: 3, sectionIdx: 4 };
            const nameIsSeparate = (detection.type === 'separate' && detection.indices.length === 2);

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                const parts = line.split(sep);

                let name = '';
                if (columnMapping.nameMode === 'separate') {
                    const a = (columnMapping.firstIdx !== null ? parts[columnMapping.firstIdx] : '') || '';
                    const b = (columnMapping.lastIdx !== null ? parts[columnMapping.lastIdx] : '') || '';
                    name = (a + ' ' + b).trim();
                } else {
                    if (columnMapping.nameIdx !== null) {
                        name = (parts[columnMapping.nameIdx] || '').trim();
                    } else if (detection.indices.length === 1 && detection.indices[0] >= 0) {
                        name = (parts[detection.indices[0]] || '').trim();
                    } else {
                        name = (parts[fallback.nameIdx] || '').trim();
                    }
                }

                const ni = (columnMapping.niIdx !== null ? (parts[columnMapping.niIdx] || '') : (niIndex >= 0 ? (parts[niIndex] || '') : (parts[fallback.niIdx] || ''))).trim();
                const table = (columnMapping.tableIdx !== null ? (parts[columnMapping.tableIdx] || '') : (tableIndex >= 0 ? (parts[tableIndex] || '') : (parts[fallback.tableIdx] || ''))).trim();
                const local = (columnMapping.localIdx !== null ? (parts[columnMapping.localIdx] || '') : (localIndex >= 0 ? (parts[localIndex] || '') : (parts[fallback.localIdx] || ''))).trim();
                const section = (columnMapping.sectionIdx !== null ? (parts[columnMapping.sectionIdx] || '') : (sectionIndex >= 0 ? (parts[sectionIndex] || '') : (parts[fallback.sectionIdx] || ''))).trim();

                if (name || ni) {
                    students.push({ name: name || ni, ni, table, local, section });
                }
            }

            console.log('√âtudiants pars√©s:', students);
            return students;
        }

        function toggleListFields() {
            const option = document.getElementById('listOption').value;
            const fields = document.getElementById('listFields');
            if (option === 'none') {
                fields.classList.add('hidden');
            } else {
                fields.classList.remove('hidden');
            }
        }

        async function generateAttendancePDF(studentsGroup, groupBy, groupValue, evalName, courseName) {
            const pdfDoc = await PDFDocument.create();
            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

            // Trier : par num√©ro de table (croissant) si par local, alphab√©tique si par section
            const sorted = [...studentsGroup].sort((a, b) => {
                if (groupBy === 'local') {
                    return parseInt(a.table, 10) - parseInt(b.table, 10);
                }
                return a.name.localeCompare(b.name, 'fr');
            });

            // Configuration du tableau
            const pageWidth = 612; // Lettre portrait
            const pageHeight = 792;
            const margin = 40;
            const titleSize = 13;
            const headerSize = 10;
            const rowSize = 10;
            const rowHeight = 22;
            const headerHeight = 25;
            const colWidths = [190, 75, 55, 75, 65]; // Nom, Matricule, Table, Section/Local, Pr√©sence
            const tableTop = pageHeight - margin - 45;

            // En-t√™tes selon le mode
            let headers, fourthColLabel;
            if (groupBy === 'local') {
                headers = ['Nom', 'Matricule', 'Table', 'Section', 'Pr√©sence'];
                fourthColLabel = 'section';
            } else {
                headers = ['Nom', 'Matricule', 'Table', 'Local', 'Pr√©sence'];
                fourthColLabel = 'local';
            }

            // Titre
            const titleLabel = groupBy === 'local' ? 'Local' : 'Section';
            const title = `Feuille de pr√©sence - ${evalName} - ${courseName} - ${titleLabel} ${groupValue}`;

            // Nombre d'√©tudiants par page
            const rowsPerPage = Math.floor((tableTop - margin - headerHeight) / rowHeight);

            let pageIndex = 0;
            let studentIndex = 0;

            while (studentIndex < sorted.length) {
                const page = pdfDoc.addPage([pageWidth, pageHeight]);
                let y = pageHeight - margin;

                // Titre
                const titleWidth = fontBold.widthOfTextAtSize(title, titleSize);
                page.drawText(title, {
                    x: (pageWidth - titleWidth) / 2,
                    y: y,
                    size: titleSize,
                    font: fontBold,
                    color: rgb(0, 0, 0),
                });
                y -= 35;

                // Calculer le d√©but X du tableau (centr√©)
                const totalTableWidth = colWidths.reduce((a, b) => a + b, 0);
                const tableX = (pageWidth - totalTableWidth) / 2;

                // En-t√™te du tableau - fond gris
                page.drawRectangle({
                    x: tableX,
                    y: y - headerHeight + 5,
                    width: totalTableWidth,
                    height: headerHeight,
                    color: rgb(0.85, 0.85, 0.85),
                });

                // Dessiner les en-t√™tes
                let colX = tableX;
                for (let c = 0; c < headers.length; c++) {
                    page.drawText(headers[c], {
                        x: colX + 5,
                        y: y - 12,
                        size: headerSize,
                        font: fontBold,
                        color: rgb(0, 0, 0),
                    });
                    colX += colWidths[c];
                }

                // Ligne sous l'en-t√™te
                y -= headerHeight;

                // Lignes de donn√©es
                const rowsOnThisPage = Math.min(rowsPerPage, sorted.length - studentIndex);
                for (let r = 0; r < rowsOnThisPage; r++) {
                    const student = sorted[studentIndex];
                    const rowY = y - (r * rowHeight);

                    // Alternance de couleur de fond
                    if (r % 2 === 0) {
                        page.drawRectangle({
                            x: tableX,
                            y: rowY - rowHeight + 5,
                            width: totalTableWidth,
                            height: rowHeight,
                            color: rgb(0.95, 0.95, 1),
                        });
                    }

                    // Donn√©es
                    const rowData = [
                        student.name,
                        student.ni,
                        student.table,
                        student[fourthColLabel],
                        '' // case vide pour pr√©sence
                    ];

                    colX = tableX;
                    for (let c = 0; c < rowData.length; c++) {
                        if (c === 4) {
                            // Case √† cocher vide (petit carr√©)
                            page.drawRectangle({
                                x: colX + 25,
                                y: rowY - 12,
                                width: 14,
                                height: 14,
                                borderColor: rgb(0, 0, 0),
                                borderWidth: 1,
                                color: rgb(1, 1, 1),
                            });
                        } else {
                            // Tronquer le texte si trop long
                            let text = rowData[c];
                            const maxWidth = colWidths[c] - 10;
                            while (font.widthOfTextAtSize(text, rowSize) > maxWidth && text.length > 1) {
                                text = text.slice(0, -1);
                            }
                            page.drawText(text, {
                                x: colX + 5,
                                y: rowY - 12,
                                size: rowSize,
                                font,
                                color: rgb(0, 0, 0),
                            });
                        }
                        colX += colWidths[c];
                    }

                    // Lignes horizontales
                    page.drawLine({
                        start: { x: tableX, y: rowY - rowHeight + 5 },
                        end: { x: tableX + totalTableWidth, y: rowY - rowHeight + 5 },
                        thickness: 0.5,
                        color: rgb(0.8, 0.8, 0.8),
                    });

                    studentIndex++;
                }

                // Bordures verticales du tableau
                const tableBottom = y - (rowsOnThisPage * rowHeight) + 5;
                const tableTopY = y + 5;
                colX = tableX;
                for (let c = 0; c <= colWidths.length; c++) {
                    page.drawLine({
                        start: { x: colX, y: tableTopY },
                        end: { x: colX, y: tableBottom },
                        thickness: 0.5,
                        color: rgb(0.6, 0.6, 0.6),
                    });
                    if (c < colWidths.length) colX += colWidths[c];
                }

                // Bordure ext√©rieure
                page.drawRectangle({
                    x: tableX,
                    y: tableBottom,
                    width: totalTableWidth,
                    height: tableTopY - tableBottom,
                    borderColor: rgb(0.4, 0.4, 0.4),
                    borderWidth: 1,
                });

                pageIndex++;
            }

            return await pdfDoc.save();
        }

        function sanitizeFileName(name) {
            // Remplacer les caract√®res sp√©ciaux par des underscores
            return name
                .replace(/[^a-zA-Z0-9√Ä-√ø\-]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');
        }

        // Permettre le glisser-d√©poser
        ['csvFile', 'pdfFile'].forEach(id => {
            const input = document.getElementById(id);
            const parent = input.parentElement;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                parent.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                parent.addEventListener(eventName, () => {
                    input.style.borderColor = '#764ba2';
                    input.style.background = '#f0f1ff';
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                parent.addEventListener(eventName, () => {
                    input.style.borderColor = '#667eea';
                    input.style.background = '#f8f9ff';
                }, false);
            });

            parent.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                input.files = files;
            }, false);
        });
    </script>
</body>
</html>
